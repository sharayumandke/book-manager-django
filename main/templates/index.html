<!DOCTYPE html>
<html>
<head>
  <title>Book Manager</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    h1 { color: #333; }
    form { margin-bottom: 20px; }
    input, button { margin: 5px; padding: 8px; }
    ul { list-style-type: none; padding: 0; }
    li { background: white; margin: 5px 0; padding: 10px; border-radius: 6px; }
    .alert { padding: 10px; margin-bottom: 15px; border-radius: 5px; display: none; }
    .alert.success { background-color: #d4edda; color: #155724; }
    .alert.error { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>ðŸ“š Book Manager</h1>
  <div id="alert" class="alert"></div>

  <!-- Add Book Form -->
  <h2>Add New Book</h2>
  <form id="add-book-form">
    <input type="number" id="id" placeholder="ID (optional)" min="1">
    <input type="text" id="title" placeholder="Title" required>
    <input type="text" id="author" placeholder="Author" required>
    <input type="number" id="price" placeholder="Price" required>
    <input type="date" id="published_date" required>
    <button type="submit">Add Book</button>
  </form>

  <!-- Update Book Form -->
  <h2>Update Book</h2>
  <form id="update-book-form">
    <input type="number" id="update-id" placeholder="Book ID" required>
    <input type="text" id="update-title" placeholder="New Title" required>
    <input type="text" id="update-author" placeholder="New Author" required>
    <input type="number" id="update-price" placeholder="New Price" required>
    <input type="date" id="update-published_date" required>
    <button type="submit">Update Book</button>
  </form>

  <!-- Delete Book Form -->
  <h2>Delete Book</h2>
  <form id="delete-book-form">
    <input type="number" id="delete-id" placeholder="Book ID" required>
    <button type="submit">Delete Book</button>
  </form>

  <!-- All Books List -->
  <h2>All Books</h2>
  <ul id="book-list"></ul>

  <!-- Chart -->
  <h2>ðŸ“Š Book Report</h2>
  <canvas id="bookChart" width="400" height="200"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // âœ… Correct Render URL for deployed backend
    const API_URL = 'https://book-manager-django.onrender.com/books/';
    const alertBox = document.getElementById('alert');
    let chartInstance = null;

    function showAlert(message, type = 'success') {
      alertBox.textContent = message;
      alertBox.className = `alert ${type}`;
      alertBox.style.display = 'block';
      setTimeout(() => { alertBox.style.display = 'none'; }, 2000);
    }

    // âœ… Load all books
    async function loadBooks() {
      const list = document.getElementById('book-list');
      try {
        const response = await fetch(API_URL, { method: 'GET', mode: 'cors' });
        if (!response.ok) throw new Error('Failed to load books');
        const data = await response.json();
        list.innerHTML = '';
        if (!data.length) {
          list.innerHTML = '<li>No books available.</li>';
        } else {
          data.forEach(book => {
            const li = document.createElement('li');
            li.textContent = `${book.id} - ${book.title} by ${book.author} (â‚¹${book.price})`;
            list.appendChild(li);
          });
        }
      } catch(err) {
        console.error('Error fetching books:', err);
        list.innerHTML = '<li>Error loading books.</li>';
      }
    }

    // âœ… Add Book
    document.getElementById('add-book-form').addEventListener('submit', async e => {
      e.preventDefault();
      const book = {
        id: document.getElementById('id').value || undefined,
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        price: document.getElementById('price').value,
        published_date: document.getElementById('published_date').value
      };
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(book),
          mode: 'cors'
        });
        if (res.ok) {
          showAlert('âœ… Book added!');
          e.target.reset();
          loadBooks();
          loadChartData();
        } else {
          console.error('Add error:', await res.text());
          showAlert('âŒ Failed to add book.', 'error');
        }
      } catch (err) {
        console.error('Add book failed:', err);
        showAlert('âŒ Failed to add book.', 'error');
      }
    });

    // âœ… Update Book
    document.getElementById('update-book-form').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('update-id').value;
      const book = {
        title: document.getElementById('update-title').value,
        author: document.getElementById('update-author').value,
        price: document.getElementById('update-price').value,
        published_date: document.getElementById('update-published_date').value
      };
      try {
        const res = await fetch(API_URL + id + '/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(book),
          mode: 'cors'
        });
        if (res.ok) {
          showAlert('âœï¸ Book updated!');
          e.target.reset();
          loadBooks();
          loadChartData();
        } else showAlert('âŒ Failed to update book.', 'error');
      } catch(err) {
        console.error('Update book failed:', err);
        showAlert('âŒ Failed to update book.', 'error');
      }
    });

    // âœ… Delete Book
    document.getElementById('delete-book-form').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('delete-id').value;
      try {
        const res = await fetch(API_URL + id + '/', { method: 'DELETE', mode: 'cors' });
        if (res.ok) {
          showAlert('ðŸ—‘ï¸ Book deleted!');
          e.target.reset();
          loadBooks();
          loadChartData();
        } else showAlert('âŒ Failed to delete book.', 'error');
      } catch(err) {
        console.error('Delete book failed:', err);
        showAlert('âŒ Failed to delete book.', 'error');
      }
    });

    // âœ… Chart reload fix
    async function loadChartData() {
      try {
        const response = await fetch(API_URL, { method: 'GET', mode: 'cors' });
        const books = await response.json();
        if (!books.length) return;

        const authorCount = {};
        books.forEach(book => {
          authorCount[book.author] = (authorCount[book.author] || 0) + 1;
        });

        const ctx = document.getElementById('bookChart').getContext('2d');
        if (chartInstance) chartInstance.destroy(); // clear old chart

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(authorCount),
            datasets: [{
              label: 'Books per Author',
              data: Object.values(authorCount),
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      } catch(err) {
        console.error('Chart error:', err);
      }
    }

    // Initial load
    loadBooks();
    loadChartData();
  </script>
</body>
</html>





